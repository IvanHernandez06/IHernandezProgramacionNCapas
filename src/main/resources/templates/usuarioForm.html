<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Detalles de Usuario</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

        <style>
            .error{
                border-color: red;

            }
            .correct{
                border-color: green
            }
        </style>


    </head>
    <body class="bg-light">
        <div class="container my-5">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">

                    <h3 class="text-center mb-4">Detalles de Usuario</h3>

                    <form  method="post" th:object="${Usuario}" th:action="@{/Usuario/addUsuarios}">


                        <input type="hidden" th:field="${IdDireccion}">




                        <div class="mb-3">
                            <label for="InputUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="InputUsername" placeholder="Ingresa tu nombre de usuario" th:field="*{Username}" required  onkeypress = " condicionalUsername(event, this)" >
                            <div class="error-msg text-danger" style="display: none;"></div>    
                        </div>

                        <div class="mb-3">
                            <label for="InputNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="InputNombre" placeholder="Ingresa tu nombre" th:field="*{Nombre}"  required onkeypress = " caracteresNoValidos(event, this)" >
                            <div class="error-msg text-danger" style="display: none;"></div>

                        </div>

                        <div class="mb-3">
                            <label for="InputApellidoPaterno" class="form-label">Apellido Paterno</label>
                            <input type="text" class="form-control" id="InputApellidoPaterno" placeholder="Ingresa tu apellido paterno" required th:field="*{ApellidoPaterno}" onkeypress="caracteresNoValidos(event, this)">
                            <div class="error-msg text-danger" style="display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="InputApellidoMaterno" class="form-label">Apellido Materno</label>
                            <input type="text" class="form-control" id="InputApellidoMaterno" placeholder="Ingresa tu apellido materno"th:field="*{ApellidoMaterno}" required onkeypress="caracteresNoValidos(event, this)">
                            <div class="error-msg text-danger" style="display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="InputEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="InputEmail" placeholder="Ingresa tu correo electrónico" th:field="*{Email}" required onkeypress="condicionalEmail(event, this)">
                            <div class="error-msg text-danger" style="display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="InputPassword" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="InputPassword" placeholder="Ingresa tu contraseña" th:field="*{Password}" required  oninput="condicionalPassword(this)"  onkeydown="bloquearTeclas(event, this)" onblur="mantenerEnfocado(this)">
                            <div class="error-msg text-danger" style="display: none;"></div>
                        </div>


                        <div class="mb-3">
                            <label for="InputConfirmPassword" class="form-label">Repite Contraseña</label>
                            <input type="password" class="form-control" id="InputConfirmPassword" placeholder="Repite tu contraseña" required oninput="validarPasswords()">
                            <div id="passwordError" class="text-danger" style="display: none;">
                                Las contraseñas no coinciden.
                            </div>
                        </div>




                        <div class="mb-3">
                            <label for="InputFechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="InputFechaNacimiento" placeholder="DD-MM-YYYY" th:field="*{FechaNacimiento}" required
                                   onchange="validarEdad(this)">
                            <div id="fechaError" class="text-danger" style="display: none;"></div>
                        </div>



                        <div class="mb-3">
                            <label for="InputSexo" class="form-label">Sexo (M/F)</label>

                            <select name="select" th:field="*{Sexo}">
                                <option value="M">Masculino</option>
                                <option value="F" selected>Femenino</option>
                            </select>

                        </div>


                        <div class="mb-3">
                            <label for="InputTelefono" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="InputTelefono"
                                   placeholder="Ingresa tu teléfono" th:field="*{Telefono}" required
                                   oninput="validarTelefono(this),'telefono'">
                            <div id="telefonoError" class="text-danger" style="display: none;"></div>
                        </div>


                        <div class="mb-3">
                            <label for="InputCelular" class="form-label">Celular</label>
                            <input type="text" class="form-control" id="InputCelular"
                                   placeholder="Ingresa tu celular" th:field="*{Celular}" required
                                   oninput="validarTelefono(this, 'celularError')">
                            <div id="celularError" class="text-danger" style="display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="InputCurp" class="form-label">Curp</label>
                            <input type="text" class="form-control" id="InputCurp" placeholder="Ingresa tu CURP" th:field="*{Curp}" required >
                        </div>

                        <div class="mb-3">
                            <label for="InputRol" class="form-label">Rol</label>

                            <select class="form-select" aria-label="Default select example">
                                <option value=0 selected>   </option>
                                <option th:each="rol : ${Roles}" th:text="${rol.nombre}" th:value="${rol.IdRol}"  th:field="*{Curp}"required>One</option>
                            </select>
                        </div>



                        <h2>Direccion</h2>


                        <table class="table table-hover">
                            <tbody>
                                <tr>
                                    <td><strong>Calle:</strong></td>
                                    <td><input type="text" class="form-control" id="InputCalle" th:field="*{Direccion[0].Calle}" required ></td>
                                </tr>
                                <tr>
                                    <td><strong>NumInterior:</strong></td><!--
                                    -->                                     <td><input type="text" class="form-control" id="InputNumInterior" th:field="*{Direccion[0].NumInterior}" required></td>
                                </tr>

                                <tr>
                                    <td><strong>NumExterior:</strong></td>
                                    <td><input type="text" class="form-control" id="InputNumExterior" th:field="*{Direccion[0].NumExterior}" required></td>
                                </tr>

                                <tr>
                                    <td><strong>Colonia:</strong></td>

                                    <td><input type="text" class="form-control" id="InputColonia" th:field="*{Direccion[0].Colonia.IdColonia}" required></td>
                                </tr>

                                <tr>
                                    <td><strong>Pais:</strong></td>
                                    <td>
                                        <select id="paisddl" class="form-select" aria-label="Default select example">
                                            <option value=0 selected>   </option>
                                            <option th:each="pais : ${Paises}" th:text="${pais.nombre}" th:value="${pais.IdPais}" required>One</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong for="estadoddl">Estado</strong></td>
                                    <td>
                                        <select  id="estadoddl" class="form-select" aria-label="Default select example" >
                                            <option value=0 selected>Selecciona su estado</option>
                                        </select>
                                    </td>
                                </tr>



                                <tr>
                                    <td><strong for="municipioddl">Municipio</strong></td>
                                    <td>
                                        <select  id="municipioddl" class="form-select" aria-label="Default select example" >
                                            <option value=0 selected>Selecciona su municipio</option>
                                        </select>
                                    </td>
                                </tr>

                                <tr>
                                    <td><strong for="coloniaddl">Colonia</strong></td>
                                    <td>
                                        <select  id="coloniaddl" class="form-select" aria-label="Default select example" >
                                            <option value=0 selected>Seleccione su colonia</option>
                                        </select>
                                    </td>
                                </tr>

                            </tbody>
                        </table>


                        <div class="d-grid gap-2">
                            <button type="submit"  class="btn btn-success mt-4 w-100 fw-bold">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <script>

            function condicionalUsername(event, input) {
                const value = input.value;
                const key = event.key;
                const regexLetra = /[a-zA-Z]/;
                const regexNumero = /[0-9]/;
                const teclasPermitidas = ["Backspace", "Delete", "ArrowLeft", "ArrowRight"];
                const simbolosPermitidos = ["_"];

                // Si el campo está vacío, solo permitir letras     
                if (value.length === 0) {
                    if (!regexLetra.test(key) && !teclasPermitidas.includes(key)) {
                        event.preventDefault();
                        $(input).siblings(".error-msg").text("No se permiten numeros ni simbolos antes de una letra").show();

                    }
                    return;
                }

                // Si ya hay al menos una letra
                if (regexLetra.test(value)) {
                    const esLetraONumero = regexLetra.test(key) || regexNumero.test(key);
                    const esSimboloPermitido = simbolosPermitidos.includes(key);
                    const esTeclaEspecial = teclasPermitidas.includes(key);

                    $(input).siblings(".error-msg").hide();
                    if (!esLetraONumero && !esSimboloPermitido && !esTeclaEspecial) {
                        event.preventDefault();
                    }
                } else {
                    // Si aún no hay letras, bloquear números y símbolos
                    if (!regexLetra.test(key) && !teclasPermitidas.includes(key)) {
                        event.preventDefault();
                    }
                }
            }

            // Validación y eliminación de caracteres
            function caracteresNoValidos(event, input) {
                let key = event.key;
                let ascii = event.keyCode;
                let regex = /^[a-zA-Z\s]*$/;

                // Si la tecla presionada no cumple con la expresión regular (es decir, es un número o un carácter no permitido)
                if (!regex.test(key)) {
                    // Evitar que el carácter se ingrese
                    event.preventDefault();

                    // Mostrar mensaje de error
                    $(input).removeClass("correct").addClass("error");
                    $(input).siblings(".error-msg").text("Solo se permiten letras y espacios, no números ni caracteres especiales").show();
                } else {
                    $(input).removeClass("error").addClass("correct");
                    $(input).siblings(".error-msg").hide(); // Ocultar el mensaje de error
                }
            }

            // Prevención de copiar, pegar y cortar
            function preventCopyPasteCut(event) {
                event.preventDefault();
                alert("No se puede copiar, pegar ni cortar en este campo.");
            }

            // Asignar los eventos de copiar, pegar y cortar
            function attachPreventCopyPasteCut(input) {
                input.addEventListener('copy', preventCopyPasteCut);
                input.addEventListener('paste', preventCopyPasteCut);
                input.addEventListener('cut', preventCopyPasteCut);
            }

            // Ejecutar la validación y las restricciones de copiar/pegar en el campo de texto
            function setupValidation() {
                const nombreInput = document.getElementById('InputNombre');
                // Añadir validación del nombre
                nombreInput.addEventListener('keypress', (event) => caracteresNoValidos(event, nombreInput));
                // Añadir prevención de copiar, pegar y cortar
                attachPreventCopyPasteCut(nombreInput);

                const apellidoPaternoInput = document.getElementById('InputApellidoPaterno');
                apellidoPaternoInput.addEventListener('keypress', (event) => caracteresNoValidos(event, apellidoPaternoInput));
                attachPreventCopyPasteCut(apellidoPaternoInput);

                const apellidoMaternoInput = document.getElementById('InputApellidoMaterno');
                apellidoPaternoInput.addEventListener('keypress', (event) => caracteresNoValidos(event, apellidoMaternoInput));
                attachPreventCopyPasteCut(apellidoMaternoInput);

                const usernameInput = document.getElementById('InputUsername');
                attachPreventCopyPasteCut(usernameInput);
            }

            // Ejecutar la configuración de validaciones al cargar la página
            document.addEventListener('DOMContentLoaded', setupValidation);


            function condicionalPassword(input) {
                const value = input.value;
                const regexMayus = /[A-Z]/;
                const regexNum = /[0-9]/;
                const regexEspecial = /[!@#$%^&*(),.?":{}|<>_\-]/;
                const errorMsg = input.nextElementSibling;

                if (value.length < 8) {
                    setInvalid(input, errorMsg, "La contraseña debe tener al menos 8 caracteres");
                    return false;
                } else if (!regexMayus.test(value)) {
                    setInvalid(input, errorMsg, "Debe contener al menos una letra mayúscula");
                    return false;
                } else if (!regexNum.test(value)) {
                    setInvalid(input, errorMsg, "Debe contener al menos un número");
                    return false;
                } else if (!regexEspecial.test(value)) {
                    setInvalid(input, errorMsg, "Debe contener al menos un carácter especial");
                    return false;
                } else {
                    setValid(input, errorMsg);
                    return true;
                }
            }

            function setInvalid(input, errorMsg, text) {
                input.classList.remove("valid");
                input.classList.add("invalid");
                errorMsg.textContent = text;
                errorMsg.style.display = "block";
            }

            function setValid(input, errorMsg) {
                input.classList.remove("invalid");
                input.classList.add("valid");
                errorMsg.style.display = "none";
            }

            function bloquearTeclas(event, input) {
                const teclasBloqueadas = ["Enter", "Tab"];
                if (teclasBloqueadas.includes(event.key) && !condicionalPassword(input)) {
                    event.preventDefault();
                }
            }

            // Evitar que salga del campo al hacer clic fuera o cambiar foco
            function mantenerEnfocado(input) {
                if (!condicionalPassword(input)) {
                    input.focus();
                }
            }

            // Validación para asegurarse de que las contraseñas coincidan
            function validarPasswords() {
                var password = document.getElementById("InputPassword").value;
                var confirmPassword = document.getElementById("InputConfirmPassword").value;
                if (password !== confirmPassword) {
                    document.getElementById("passwordError").style.display = "block";
                    document.getElementById("InputConfirmPassword").setCustomValidity("Las contraseñas no coinciden");
                } else {
                    document.getElementById("passwordError").style.display = "none";
                    document.getElementById("InputConfirmPassword").setCustomValidity('');
                }
            }


            function validarEdad(input) {
                const fechaSeleccionada = new Date(input.value);
                const hoy = new Date();

                if (!input.value) {
                    mostrarError("La fecha es obligatoria");
                    return false;
                }

                // Calcular la edad en años
                let edad = hoy.getFullYear() - fechaSeleccionada.getFullYear();
                const mesDiff = hoy.getMonth() - fechaSeleccionada.getMonth();
                const diaDiff = hoy.getDate() - fechaSeleccionada.getDate();

                // Ajustar edad si no ha cumplido años en este año
                if (mesDiff < 0 || (mesDiff === 0 && diaDiff < 0)) {
                    edad--;
                }

                if (edad < 18) {
                    mostrarError("Debes ser mayor de 18 años");
                    input.value = "";
                    input.focus();
                    return false;
                } else if (edad > 100) {
                    mostrarError("La edad no puede ser mayor a 100 años");
                    input.value = "";
                    input.focus();
                    return false;
                } else {
                    ocultarError();
                    return true;
                }

                function mostrarError(msg) {
                    const errorDiv = document.getElementById("fechaError");
                    errorDiv.textContent = msg;
                    errorDiv.style.display = "block";
                }

                function ocultarError() {
                    const errorDiv = document.getElementById("fechaError");
                    errorDiv.style.display = "none";
                }
            }


            function validarTelefono(input, errorId = "telefonoError") {
                const valor = input.value;
                let soloNumeros = valor.replace(/\D/g, '');

                // Limitar a 15 caracteres
                if (soloNumeros.length > 15) {
                    soloNumeros = soloNumeros.slice(0, 15);
                }

                input.value = soloNumeros;

                const errorDiv = document.getElementById(errorId);

                if (soloNumeros.length < 10) {
                    errorDiv.textContent = "El número debe tener al menos 10 dígitos.";
                    errorDiv.style.display = "block";
                    input.classList.add("error");
                    input.classList.remove("correct");
                } else if (soloNumeros.length > 15) {
                    errorDiv.textContent = "El número no puede tener más de 15 dígitos.";
                    errorDiv.style.display = "block";
                    input.classList.add("error");
                    input.classList.remove("correct");
                } else {
                    errorDiv.style.display = "none";
                    input.classList.remove("error");
                    input.classList.add("correct");
            }
            }


            $(document).ready(function () {
                $("#paisddl").change(function () {
                    $.ajax({
                        type: "GET",
                        url: "/Usuario/getEstadosByIdPais/" + $("#paisddl").val(),
                        dataType: 'json',
                        success: function (data, textStatus, jqXHR) {
                            if (data.correct) {
                                $("#estadoddl").empty(); // id correcto
                                $("#estadoddl").append("<option value='0' selected>Selecciona su estado</option>");
                                $("#municipioddl").append("<option value='0' selected>Selecciona su municipio</option>");
                                $("#coloniaddl").append("<option value='0' selected>Selecciona su colonia</option>");

                                $.each(data.objects, function (indice, estado) {
                                    $("#estadoddl").append(
                                            "<option value='" + estado.idEstado + "'>" + estado.nombre + "</option>"
                                            );
                                });
                            } else {
                                console.log("No se encontraron estados para el país seleccionado.");
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error al obtener los estados.");
                        }
                    });
                });
            });





            $(document).ready(function () {
                $("#estadoddl").change(function () {
                    $.ajax({
                        type: "GET",
                        url: "/Usuario/getMunicipiosByIdEstados/" + $("#estadoddl").val(),
                        dataType: 'json',
                        success: function (data, textStatus, jqXHR) {
                            if (data.correct) {
                                $("#municipioddl").empty(); // id correcto
                                $("#municipioddl").append("<option value='0' selected>Selecciona su municipio</option>");
                                $("#coloniaddl").append("<option value='0' selected>Selecciona su colonia</option>");

                                $.each(data.objects, function (indice, municipio) {
                                    $("#municipioddl").append(
                                            "<option value='" + municipio.idMunicipio + "'>" + municipio.nombre + "</option>"
                                            );
                                });
                            } else {
                                console.log("No se encontraron estados para el país seleccionado.");
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error al obtener los estados.");
                        }
                    });
                });
            });



            $(document).ready(function () {
                $("#municipioddl").change(function () {
                    $.ajax({
                        type: "GET",
                        url: "/Usuario/getColoniasByIdMunicipios/" + $("#municipioddl").val(),
                        dataType: 'json',
                        success: function (data, textStatus, jqXHR) {
                            if (data.correct) {
                                $("#coloniaddl").empty(); // id correcto
                                $("#coloniaddl").append("<option value='0' selected>Selecciona su colonia</option>");

                                $.each(data.objects, function (indice, colonia) {
                                    $("#coloniaddl").append(
                                            "<option value='" + colonia.idColonia + "'>" + colonia.nombre + "</option>"
                                            );
                                });
                            } else {
                                console.log("No se encontraron estados para el país seleccionado.");
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error al obtener los estados.");
                        }
                    });
                });
            });


//
//

        </script>
    </body>

</html>




